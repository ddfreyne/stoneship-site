

    
        <meta charset="utf-8">

        <title>Nanoc needs file paths to be known before compilation starts</title>

        <!-- metadata -->

        <meta name="generator" content="Nanoc 4.12.2">

        

        <meta property="og:site_name" content="denisdefreyne.com">

        <meta property="og:url" content="https://denisdefreyne.com/notes/xpflx-zplmt-xhw7z/">

        <meta property="og:title" content="Nanoc needs file paths to be known before compilation starts">
        <meta property="dc.title" content="Nanoc needs file paths to be known before compilation starts">

        <meta property="og:type" content="website">

        

        
            <meta property="og:description" content="A note in Denis’ digital garden.">
        

        
            <link rel="stylesheet" href="../../assets/style/reset-x474zZ4mc7j473vXXmQEP4oTpk.css">
            <link rel="stylesheet" href="../../assets/fonts/main.css">
        
        
        <link rel="stylesheet" href="../../assets/style/2021q1-e5pYXFnTk2scH3DXlZyKYPoCG2c.css">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <script>
            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-15639968-2']);
            _gaq.push(['_trackPageview']);

            (function() {
             var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
             ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
             var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
             })();
        </script>
    
    
    
        <div class="above-footer">
            <nav class="nav">
                <ul>
                    <li><a href="../../">denisdefreyne.com</a></li>
                    <li><a href="../../software/">software</a></li>
                    <li><a href="../../talks/">talks</a></li>
                    <li><a href="../../experiments/">experiments</a></li>
                    <li><a href="../">notes</a></li>
                    <li><a href="../../cv/">cv</a></li>
                </ul>
            </nav>

            <article class="container primary">
                <h1>Nanoc needs file paths to be known before compilation&nbsp;starts</h1>


<p>In Nanoc, routing strictly happens before compilation. This prevents an output filename from depending on the compiled&nbsp;content.</p>

<h2 id="example-fingerprinting">Example:&nbsp;Fingerprinting</h2>
<p>This is limiting particularly for stylesheet fingerprinting. Ideally, each stylesheet contains the hash of its own <em>compiled</em> content in the filename, but Nanoc is only able to calculate a hash from the raw, uncompiled&nbsp;input.</p>

<p>As an example, here is how the <a href="https://nanoc.ws">nanoc.ws</a> web site handles fingerprinting for&nbsp;stylesheets:</p>

<pre><code class="language-ruby">compile '/assets/style/*' do
  filter :sass, syntax: :scss
  write item.identifier.without_ext + '-' + fingerprint('/assets/style/*') + '.css'
end
</code></pre>

<pre><code class="language-ruby">def fingerprint(pattern)
  contents = @items.find_all(pattern).map do |i|
    i.binary? ? File.read(i[:filename]) : i.raw_content
  end
  Digest::SHA1.hexdigest(contents.join(''))[0..15]
end
</code></pre>

<p>The implementation of <code>#fingerprint</code> looks icky, but there is a bigger&nbsp;issue.</p>

<p>If multiple stylesheets exist (e.g. <span class="path">/assets<wbr>/style<wbr>/screen<wbr>.scss<wbr></span> and <span class="path">/assets<wbr>/style<wbr>/print<wbr>.scss<wbr></span>), their filenames will depend on all partials and all non-partials in the  <span class="path">/assets<wbr>/style<wbr></span> directory, which might cause a stylesheet’s fingerprint to change even though their contents haven’t&nbsp;changed.</p>

<h2 id="causes">Causes</h2>
<p>For each item, Nanoc runs several outdatedness rules, which determine whether or not the item is outdated and thus needs to be recompiled. These outdatedness rules answer questions such as&nbsp;these:</p>

<ul>
  <li>Was the content modified?</li>
  <li>Were the attributes modified?</li>
  <li>Did the routing rule(s) change for this item?</li>
  <li>Does the corresponding file in the output directory exist?</li>
</ul>

<p>If none of these outdatedness rules respond with “yes,” the item is not considered to be outdated, and will not be&nbsp;recompiled.</p>

<p>The last mentioned outdatedness rule in the list above is of interest: if the corresponding output file does not exist, Nanoc will consider the item as outdated, and compile&nbsp;it.</p>

<p>This is why Nanoc needs to know the file path before compiling the&nbsp;item.</p>

<h2 id="workaround">Workaround</h2>
<p>A dependency-querying API would help for generating fingerprints that are taken from only the necessary items. In the stylesheet fingerprinting example above, the <code>fingerprint(glob)</code> call would become <code>fingerprint(item)</code>, and <code>@items.find_all(pattern)</code> would become something like <code>item.dependencies</code>.</p>

<p>Such a dependency-querying API wouldn’t solve the underlying problem of not being able to generate a fingerprint from the <em>compiled</em> content,&nbsp;however.</p>

<h2 id="resolution">Resolution</h2>
<p><mark><strong>To do:</strong> Probably solvable if Nanoc uses an internal output databases that relies on item identifiers (or arbitrarily-assigned UUIDs) rather than paths. CoW would then help with reducing filesystem usage.
</mark></p>

<h2 id="references">References</h2>
<p>GitHub. “Cache Fingerprinting Doesn’t Take Account of Change to Non-Partial · Issue #251 · nanoc/nanoc.ws.” Accessed January 12, 2021. <a href="https://github.com/nanoc/nanoc.ws/issues/251">https://github.com/nanoc/nanoc.ws/issues/251</a>.</p>


<div class="hr"></div>

<div class="col-left-sm main-footer muted">
  <div>Last revised:</div>
  <div class="pb-base">March 2021</div>
</div>

<div class="col-center-sm main-footer muted">
  
</div>

            </article>
        </div>

        <footer class="footer muted">
            <div>© 2007–2021</div>
            <div>made in Berlin</div>
        </footer>

        <script>hljs.highlightAll();</script>
    


    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js"></script>


